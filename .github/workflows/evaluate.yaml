name: Evaluate

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-load-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        # Would like to install snyth and generate fake data via docker compose but gh actions
        # does not like compose volumes, so manually generate it here instead
      - name: Install synth
        run: curl --proto "=https" --tlsv1.2 -sSL https://getsynth.com/install | sh -s -- --ci
      - name: Generate fake data
        run: cd scripts/generate-fake-data && synth generate . --collection logs --size 1000 --to json:./test-data.json && mv ./test-data.json ../../test-data.json
      - name: Remove lines from docker compose
        run: pwd && yq eval -i 'del(.services."generate-fake-data") | del(.services.replay-load-test.depends_on[1]) | del(.services.replay-load-test.volumes[1]) | del(.volumes)' docker-compose.yaml
      - name: Run docker compose
        run: docker compose up
      - name: Point container logs to summary
        run: docker logs $(docker container ls --all  | grep 'replay-load-test-replay-load-test' | awk '{print $1}') >> $GITHUB_STEP_SUMMARY